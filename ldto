#!/bin/sh

# Copyright (C) 2021 Da Xue <da@libre.computer>
# All rights reserved. 
# PURPOSE: Manage the application and removal of device tree overlays in the Linux kernel.

if [ "$USER" != "root" ]; then
	echo "Please run this as root." >&2
	exit 1
fi

if [ -z "$VENDOR" ]; then
	if [ ! -e /sys/class/dmi/id/board_vendor ]; then
		echo "No vendor found!" >&2
		exit 1
	fi
	VENDOR=$(tr -d '\0' < /sys/class/dmi/id/board_vendor)
fi


if [ -z "$BOARD" ]; then
	if [ ! -e /sys/class/dmi/id/board_name ]; then
		echo "No boardname found!" >&2
		exit 1
	fi
	BOARD=$(tr -d '\0' < /sys/class/dmi/id/board_name)
fi

cd $(CDPATH= cd -- "$(dirname -- "$0")" && pwd -P)

OVERLAYS=/sys/kernel/config/device-tree/overlays

FIRMWARE=$VENDOR/$BOARD

LDTO_enableOverlay()
{
	if [ -z "$1" ]; then
		LDTO_listOverlays
		return 1
	fi
	DTBO="$FIRMWARE/$1.dtbo"
	if [ ! -f $DTBO ]; then
		echo "Overlay $1: does not exist and cannot be added" >&2
		return 1
	fi
	if [ -e $OVERLAYS/$1 ]; then
		echo "Overlay $1: already exists" >&2
		return 1
	fi
	mkdir $OVERLAYS/$1
	cat $FIRMWARE/$1.dtbo > $OVERLAYS/$1/dtbo
	echo "Overlay $1: `cat $OVERLAYS/$1/status`" >&2
}

LDTO_disableOverlay()
{
	if [ -z "$1" ]; then
		listActiveOverlays
		return 1
	fi
	if [ ! -e "$OVERLAYS/$1" ]; then
		echo "Overlay $1: does not exist and cannot be removed" >&2
		return 1
	fi
	rmdir $OVERLAYS/$1
	echo "Overlay $1: removed" >&2
}

LDTO_listActiveOverlays()
{
	echo "#Active Overlays:" >&2
	for i in `ls $OVERLAYS`;
	do
		basename $i
	done
}
LDTO_listOverlays()
{
	LDTO_listActiveOverlays

	echo "#Available Overlays:" >&2
	for i in $FIRMWARE/*.dtbo
	do
		basename $i .dtbo
	done
}
LDTO_isActiveOverlay()
{
	if [ -z "$1" ]; then
		return 1
	fi
	for i in `ls $OVERLAYS`;
	do
		if [ "$1" = $(basename $i) ]; then
			return 0
		fi
	done
	return 1
}

LDTO_showHelp()
{
	echo "$0 list"
	echo "$0 isActive [OVERLAY]"
	echo "$0 enable [OVERLAY]"
	echo "$0 disable [OVERLAY]"
}

cmd=LDTO_showHelp
case "$1" in
	enable)
		cmd=LDTO_enableOverlay
		;;
	disable)
		cmd=LDTO_disableOverlay
		;;
	list)
		cmd=LDTO_listOverlays
		;;
	listActive)
		cmd=LDTO_listActiveOverlays
		;;
	isActive)
		cmd=LDTO_isActiveOverlay
		;;
	*)
		$cmd
		exit 1
		;;
esac
shift
$cmd $@

